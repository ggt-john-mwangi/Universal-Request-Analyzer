<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Universal Request Analyzer</title>
  <link rel="stylesheet" href="../styles.css"> <!-- Global styles -->
  <link rel="stylesheet" href="css/popup.css"> <!-- Popup specific styles -->
  <link rel="stylesheet" href="css/themes.css"> <!-- Theme styles -->
  <link rel="stylesheet" href="css/data-visualization.css"> <!-- Visualization styles -->
  <link rel="stylesheet" href="assets/fontawesome/css/all.min.css">
</head>

<body class="popup_container no-scrollbar">
  <header class="popup_header">
    <div class="logo">
      <img src="assets/icons/icon48.png" alt="URA">
    </div>
    <!-- <h1 class="title">Universal Request Analyzer</h1> -->
    <div class="controls">
      <button id="clearBtn" class="control-btn danger-btn" title="Clear all requests">
        <i class="fas fa-trash"></i> Clear
      </button>
      <button id="exportBtn" class="control-btn" title="Export Data">
        <i class="fas fa-download"></i> Export
      </button>
      <button id="importBtn" class="control-btn" title="Import Data"> <!-- Added Import Button -->
        <i class="fas fa-upload"></i> Import
      </button>
      <button id="filterBtn" class="control-btn" title="Filter requests">
        <i class="fas fa-filter"></i> Filter
      </button>
      <button id="refreshBtn" class="control-btn" title="Refresh Data">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
      <button id="openOptions" class="control-btn" title="Open Options Page">
        <i class="fas fa-cog"></i> Options <!-- Changed icon and text -->
      </button>
      <!-- <button id="exportDbBtn" class="control-btn" title="Export DB">
        <i class="fas fa-database"></i> Export DB 
      </button> -->
    </div>
  </header>

  <div class="filter-panel " id="filterPanel">
    <div class="filter-row">
      <label for="statusFilter">
        <i class="fas fa-info-circle"></i> Status:
      </label>
      <select id="statusFilter">
        <option value="all">All</option>
        <option value="completed">Completed</option>
        <option value="pending">Pending</option>
        <option value="error">Error</option>
      </select>
    </div>
    <div class="filter-row">
      <label for="typeFilter">
        <i class="fas fa-tags"></i> Type:
      </label>
      <select id="typeFilter">
        <option value="all">All</option>
        <option value="xmlhttprequest">XHR</option>
        <option value="fetch">Fetch</option>
        <option value="script">Script</option>
        <option value="stylesheet">Stylesheet</option>
        <option value="image">Image</option>
        <option value="font">Font</option>
        <option value="other">Other</option>
      </select>
    </div>
    <div class="filter-row">
      <label for="domainFilter">
        <i class="fas fa-globe"></i> Domain:
      </label>
      <input type="text" id="domainFilter" placeholder="Filter by domain">
    </div>
    <div class="filter-row">
      <label for="urlFilter">
        <i class="fas fa-link"></i> URL contains:
      </label>
      <input type="text" id="urlFilter" placeholder="Filter by URL">
    </div>
    <div class="filter-row">
      <label for="dateRangeFilter">
        <i class="fas fa-calendar-alt"></i> Date Range:
      </label>
      <div class="date-range">
        <input type="date" id="startDateFilter">
        <span>to</span>
        <input type="date" id="endDateFilter">
      </div>
    </div>
    <div class="filter-actions">
      <button id="applyFilterBtn">Apply</button>
      <button id="resetFilterBtn">Reset</button>
    </div>
  </div>

  <div class="export-panel" id="exportPanel" style="display: none;"> <!-- Initially hidden -->
    <h4>Export Data</h4>
    <div class="export-row">
      <label for="exportFormat">Format:</label>
      <select id="exportFormat">
        <!-- Options populated by export-manager -->
      </select>
    </div>
    <div class="export-row">
      <label for="exportFilename">Filename:</label>
      <input type="text" id="exportFilename" placeholder="Export filename (without extension)">
    </div>
    <div class="export-row">
      <label>Size (Approx):</label> <!-- Changed label -->
      <span id="exportDbSize">Loading...</span> <!-- Added element for DB size -->
    </div>
    <div class="export-actions">
      <button id="doExportBtn">Export</button>
      <button id="cancelExportBtn">Cancel</button>
    </div>
  </div>

  <!-- Added Import Panel -->
  <div class="import-panel" id="importPanel" style="display: none;">
    <h4>Import Data</h4>
    <div class="import-row">
      <label for="importFile">Select File:</label>
      <input type="file" id="importFile" accept=".json,.csv,.sqlite,.db">
    </div>
    <!-- Optional: Add format selection if needed, otherwise detect from extension -->
    <!-- <div class="import-row">
      <label for="importFormat">Format:</label>
      <select id="importFormat">
        <option value="auto">Auto-detect</option>
        <option value="json">JSON</option>
        <option value="csv">CSV</option>
        <option value="sqlite">SQLite</option>
      </select>
    </div> -->
    <div class="import-actions">
      <button id="doImportBtn">Import</button>
      <button id="cancelImportBtn">Cancel</button>
    </div>
    <div id="importStatus" class="import-status" style="margin-top: 5px;"></div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="requests">Requests</button>
    <button class="tab-btn" data-tab="stats">Statistics</button>
    <button class="tab-btn" data-tab="plots">Plots</button>
  </div>

  <div class="tab-content active" id="requests-tab">
    <div class="stats-panel">
      <div class="stat-item">
        <span class="stat-label">Total Requests:</span>
        <span class="stat-value" id="totalRequests">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Avg. Response Time:</span>
        <span class="stat-value" id="avgResponseTime">0 ms</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Success Rate:</span>
        <span class="stat-value" id="successRate">0%</span>
      </div>
    </div>

    <div class="requests-container">
      <div class="requests-table-toolbar">
        <div class="search-input-wrapper">
          <i class="fas fa-search"></i>
          <input type="text" id="requestsTableSearch" placeholder="Search requests..." autocomplete="off">
        </div>
      </div>
      <table id="requestsTable">
        <thead>
          <tr>
            <th data-sort="method" class="sortable">Method</th>
            <th data-sort="domain" class="sortable">Domain</th>
            <th data-sort="path" class="sortable">Path</th>
            <th data-sort="status" class="sortable">Status</th>
            <th data-sort="type" class="sortable">Type</th>
            <th data-sort="size" class="sortable">Size</th>
            <th data-sort="duration" class="sortable">Duration</th>
            <th data-sort="time" class="sortable">Time</th>
          </tr>
        </thead>
        <tbody id="requestsTableBody">
          <!-- Request rows will be added here dynamically -->
        </tbody>
      </table>
      <div class="pagination">
        <button id="prevPageBtn" disabled>&laquo; Previous</button>
        <span id="pageInfo">Page 1 of 1</span>
        <button id="nextPageBtn" disabled>Next &raquo;</button>
      </div>
    </div>
  </div>

  <div class="tab-content" id="stats-tab">
    <div class="stats-grid">
      <div class="stats-card">
        <h3>Request Summary</h3>
        <div class="stats-data">
          <div class="stat-row">
            <span class="stat-name">Total Requests:</span>
            <span class="stat-value" id="statsTotalRequests">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-name">Average Response Time:</span>
            <span class="stat-value" id="statsAvgResponseTime">0 ms</span>
          </div>
          <div class="stat-row">
            <span class="stat-name">Successful Requests:</span>
            <span class="stat-value" id="statsSuccessfulRequests">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-name">Failed Requests:</span>
            <span class="stat-value" id="statsFailedRequests">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-name">Database Size:</span>
            <span class="stat-value" id="statsDbSize">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-name">Avg. DNS Time:</span>
            <span class="stat-value" id="statsAvgDns">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-name">Avg. TCP Time:</span>
            <span class="stat-value" id="statsAvgTcp">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-name">Avg. SSL Time:</span>
            <span class="stat-value" id="statsAvgSsl">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-name">Avg. TTFB:</span>
            <span class="stat-value" id="statsAvgTtfb">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-name">Avg. Download Time:</span>
            <span class="stat-value" id="statsAvgDownload">-</span>
          </div>
        </div>
      </div>

      <div class="stats-card">
        <h3>Status Codes</h3>
        <div id="statsStatusCodes">-</div>
      </div>

      <div class="stats-card">
        <h3>Top Domains</h3>
        <div id="statsTopDomains">-</div>
      </div>

      <div class="stats-card">
        <h3>Request Types</h3>
        <div id="statsRequestTypes">-</div>
      </div>

      <div class="stats-card">
        <h3>Advanced Stats</h3>
        <div class="stats-data">
          <div class="stat-row">
            <span class="stat-name">Error Rate:</span>
            <span class="stat-value" id="statsErrorRate">0%</span>
          </div>
          <div class="stat-row">
            <span class="stat-name">Slowest Request:</span>
            <span class="stat-value" id="statsSlowest">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-name">Most Common Domain:</span>
            <span class="stat-value" id="statsMostDomain">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-name">Most Common Type:</span>
            <span class="stat-value" id="statsMostType">-</span>
          </div>
          <div class="stat-row">
            <span class="stat-name">Most Common Method:</span>
            <span class="stat-value" id="statsMostMethod">-</span>
          </div>
        </div>
      </div>

      <div class="stats-card">
        <h3>Requests per Domain (Top 5)</h3>
        <div class="stats-data">
          <table id="statsRequestsPerDomain" class="stats-summary-table">
            <thead><tr><th>Domain</th><th>Count</th><th>Avg Duration</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="stats-card">
        <h3>Requests per Method</h3>
        <div class="stats-data">
          <table id="statsRequestsPerMethod" class="stats-summary-table">
            <thead><tr><th>Method</th><th>Count</th><th>Avg Duration</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="stats-card">
        <h3>Requests per Status Code</h3>
        <div class="stats-data">
          <table id="statsRequestsPerStatus" class="stats-summary-table">
            <thead><tr><th>Status</th><th>Count</th><th>Avg Duration</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="stats-card">
        <h3>Top 5 Slowest Requests</h3>
        <div class="stats-data">
          <table id="statsTopSlowestRequests" class="stats-summary-table">
            <thead><tr><th>URL</th><th>Duration</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="statsTimeWindowSelector" style="margin-bottom: 10px;"></div>
  </div>

  <div class="tab-content" id="plots-tab">
    <!-- Content for Plots tab will go here -->
    <p>Plots content placeholder.</p>
  </div>

  <div id="notification" class="notification"></div>

  <div id="requestDetails" class="request-details">
    <div class="details-header">
      <h3>Request Details</h3>
      <button id="closeDetails">×</button>
    </div>
    <div class="details-content">
      <div class="detail-row">
        <span class="detail-label">URL:</span>
        <span class="detail-value" id="detailUrl"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Method:</span>
        <span class="detail-value" id="detailMethod"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Status:</span>
        <span class="detail-value" id="detailStatus"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Type:</span>
        <span class="detail-value" id="detailType"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Domain:</span>
        <span class="detail-value" id="detailDomain"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Path:</span>
        <span class="detail-value" id="detailPath"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Size:</span>
        <span class="detail-value" id="detailSize"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Start Time:</span>
        <span class="detail-value" id="detailStartTime"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">End Time:</span>
        <span class="detail-value" id="detailEndTime"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Duration:</span>
        <span class="detail-value" id="detailDuration"></span>
      </div>

      <h4>Timing Breakdown</h4>
      <div class="timing-chart">
        <div class="timing-bar-container">
          <div class="timing-label">DNS</div>
          <div class="timing-bar-wrapper">
            <div class="timing-bar dns-bar" id="dnsBar"></div>
            <span class="timing-value" id="dnsTime"></span>
          </div>
        </div>
        <div class="timing-bar-container">
          <div class="timing-label">TCP</div>
          <div class="timing-bar-wrapper">
            <div class="timing-bar tcp-bar" id="tcpBar"></div>
            <span class="timing-value" id="tcpTime"></span>
          </div>
        </div>
        <div class="timing-bar-container">
          <div class="timing-label">SSL</div>
          <div class="timing-bar-wrapper">
            <div class="timing-bar ssl-bar" id="sslBar"></div>
            <span class="timing-value" id="sslTime"></span>
          </div>
        </div>
        <div class="timing-bar-container">
          <div class="timing-label">TTFB</div>
          <div class="timing-bar-wrapper">
            <div class="timing-bar ttfb-bar" id="ttfbBar"></div>
            <span class="timing-value" id="ttfbTime"></span>
          </div>
        </div>
        <div class="timing-bar-container">
          <div class="timing-label">Download</div>
          <div class="timing-bar-wrapper">
            <div class="timing-bar download-bar" id="downloadBar"></div>
            <span class="timing-value" id="downloadTime"></span>
          </div>
        </div>
      </div>

      <h4>Headers</h4>
      <div class="headers-container" id="headersContainer">
        <!-- Headers will be added here dynamically -->
      </div>
    </div>
  </div>

  <!-- Notification Element -->
  <div id="notification" class="notification"></div>

  <script type="module" src="js/popup.js"></script>
</body>

</html>